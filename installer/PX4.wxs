<?xml version="1.0" encoding="windows-1252"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
	<Product Name="PX4 Toolchain" Id="*" UpgradeCode="EED21B28-B4E2-4F96-91EC-DCC54227CF52"
		Language="1033" Codepage="1252" Version="0.3.0" Manufacturer="Dronecode">

		<Package Id="*" Keywords="Installer" Description="PX4 Windows Toolchain Installer"
			Comments="Created by MaEtUgR" Manufacturer="Dronecode"
			InstallerVersion="100" Languages="1033" Compressed="yes" SummaryCodepage="1252" InstallScope="perMachine" />
		
		<!-- remove all other versions -->
		<MajorUpgrade AllowSameVersionUpgrades="yes" DowngradeErrorMessage="A newer version of [ProductName] is already installed." />

		<Media Id="1" Cabinet="PX4.cab" EmbedCab="yes" DiskPrompt="#1" />
		<Property Id="DiskPrompt" Value="PX4 installer" />

		<Feature Id="Complete" Title="PX4 Toolchain" Description="The complete package." Level="1" ConfigurableDirectory="INSTALLDIR">
			<ComponentGroupRef Id="MainComponents" />
			<ComponentRef Id="SaveInformationForUpdate" />
		</Feature>

		<!-- Realias the system drive to work around the error:
		"The directory name: WindowsVolume is the same as one of the MSI Public Properties and can cause unforeseen side effects." -->		
		<SetDirectory Id="WINDOWSVOLUME" Value="[WindowsVolume]"/>
		
		<Directory Id="TARGETDIR" Name="SourceDir">
			<!-- unused directory layer to trick WiX light such that it autogenerates GUIDs -->
			<Directory Id='ProgramFilesFolder' Name='PFiles'>
				<Directory Id="WINDOWSVOLUME">
					<Directory Id="INSTALLDIR" Name="PX4" />
					
					<!-- Save version and install directory for updates -->
					<Component Id="SaveInformationForUpdate">
						<RegistryValue Root="HKLM" Key="Software\[Manufacturer]\[ProductName]" Name="InstalledVersion" Type="string" Value="[ProductVersion]" />
						<RegistryValue Root="HKLM" Key="Software\[Manufacturer]\[ProductName]" Name="InstallDir" Type="string" Value="[INSTALLDIR]" />
					</Component>
				</Directory>
			</Directory>
		</Directory>
		
		<!-- Get version and install directory for updates -->
		<Property Id="INSTALLEDPRODUCTVERSION">
			<RegistrySearch Id='RegistryInstalledVersion' Type='raw' Root='HKLM' Key="Software\[Manufacturer]\[ProductName]" Name='InstalledVersion' />
		</Property>
		<Property Id="INSTALLDIR">
			<RegistrySearch Id='RegistryInstallDir' Type='raw' Root='HKLM' Key="Software\[Manufacturer]\[ProductName]" Name='InstallDir' />
		</Property>
		
		<!-- Background pictures and license -->
		<WixVariable Id="WixUIBannerBmp" Value="..\banner.bmp" />
		<WixVariable Id="WixUIDialogBmp" Value="..\side.bmp" />
		<WixVariable Id="WixUILicenseRtf" Value="..\license.rtf" />
		
		<!-- Restore symbolic links after installation -->
		<CustomAction Id="SymlinksRestoreAction" ExeCommand="[INSTALLDIR]toolchain\symlinks-restore-after-install.bat" Directory="INSTALLDIR" Execute='deferred' Impersonate='no' Return='ignore'/>
		<CustomAction Id="SymlinksRemoveBackupAction" ExeCommand="[INSTALLDIR]toolchain\symlinks-remove-backup.bat" Directory="INSTALLDIR" Execute='deferred' Impersonate='no' Return='ignore'/>
		<InstallExecuteSequence>
			<Custom Action="SymlinksRestoreAction" Before="InstallFinalize">NOT (REMOVE~="ALL")</Custom>
			<Custom Action="SymlinksRemoveBackupAction" After="SymlinksRestoreAction">NOT (REMOVE~="ALL")</Custom>
		</InstallExecuteSequence>
		
		<!-- Clone and start after installation -->
		<Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Clone PX4 Repository and Start Simulation" />
		<CustomAction Id="LaunchAfterInstall" ExeCommand="[INSTALLDIR]toolchain\clone-px4-run-sitl.bat" Directory="INSTALLDIR" Execute='immediate' Impersonate='yes' Return='asyncNoWait'/>
		<UI>
			<Publish Dialog="ExitDialog" Control="Finish" Event="DoAction" Value="LaunchAfterInstall">WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed</Publish>
		</UI>
		
		<UIRef Id="WixUI_Custom" />
		<UIRef Id="WixUI_ErrorProgressText" />
		
	</Product>
</Wix>
